#!/usr/bin/env bash
set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
RESET='\033[0m'

DRY_RUN=false

usage() {
  cat <<HELP
Usage: bin/release [OPTIONS] [VERSION]

Prepare and tag a new release of kiso-icons.

Arguments:
  VERSION           Version to release (e.g. 0.1.0, 1.0.0)
                    If omitted, you'll be prompted interactively.

Options:
  -h, --help        Show this help message
  -n, --dry-run     Run preflight checks and tests without committing or tagging

Steps performed:
  1. Preflight checks (clean tree, on master, synced with origin)
  2. Run full test suite and linter
  3. Check CHANGELOG.md has unreleased entries
  4. Bump version in lib/kiso/icons/version.rb
  5. Update CHANGELOG.md (move Unreleased → version heading)
  6. Verify gem builds
  7. Commit version bump and create annotated tag
  8. Push to origin and create GitHub Release

Examples:
  bin/release 0.1.0       # release version 0.1.0
  bin/release --dry-run   # run checks without committing
  bin/release             # interactive prompt for version
HELP
  exit 0
}

step() { echo -e "\n${CYAN}==> $1${RESET}"; }
ok()   { echo -e "${GREEN}  ✓ $1${RESET}"; }
warn() { echo -e "${YELLOW}  ! $1${RESET}"; }
die()  { echo -e "${RED}  ✗ $1${RESET}"; exit 1; }

# --- Parse arguments ---
NEW_VERSION=""
for arg in "$@"; do
  case "$arg" in
    -h|--help) usage ;;
    -n|--dry-run) DRY_RUN=true ;;
    -*) die "Unknown option: $arg (see --help)" ;;
    *) NEW_VERSION="$arg" ;;
  esac
done

# --- Read current version ---
CURRENT_VERSION=$(ruby -r ./lib/kiso/icons/version -e 'puts Kiso::Icons::VERSION')

# --- Determine new version ---
if [ -z "$NEW_VERSION" ]; then
  echo "Current version: ${CURRENT_VERSION}"
  echo ""
  echo "Enter new version (e.g. 0.1.0, 0.2.0, 1.0.0):"
  read -r NEW_VERSION
fi

if [ -z "$NEW_VERSION" ]; then
  die "Version cannot be empty"
fi

TAG="v${NEW_VERSION}"
TODAY=$(date +%Y-%m-%d)

step "Preflight checks"

# Clean working tree?
if [ -n "$(git status --porcelain)" ]; then
  die "Working tree is not clean. Commit or stash changes first."
fi
ok "Working tree clean"

# On main branch?
BRANCH=$(git branch --show-current)
if [ "$BRANCH" != "master" ]; then
  die "Not on master branch (on ${BRANCH}). Switch to master first."
fi
ok "On master branch"

# Up to date with remote?
git fetch origin --quiet
LOCAL=$(git rev-parse HEAD)
REMOTE=$(git rev-parse origin/master)
if [ "$LOCAL" != "$REMOTE" ]; then
  die "Local master is not up to date with origin. Pull first."
fi
ok "Up to date with origin/master"

# Tag doesn't already exist?
if git rev-parse "$TAG" >/dev/null 2>&1; then
  die "Tag ${TAG} already exists"
fi
ok "Tag ${TAG} is available"

# gh CLI available?
if ! command -v gh &>/dev/null; then
  die "gh CLI not found. Install it: https://cli.github.com"
fi
ok "gh CLI available"

# CHANGELOG.md has unreleased entries?
UNRELEASED_CONTENT=$(sed -n '/^## \[Unreleased\]/,/^## \[/{/^## \[/!p;}' CHANGELOG.md | sed '/^$/d')
if [ -z "$UNRELEASED_CONTENT" ]; then
  die "CHANGELOG.md has no entries under [Unreleased]. Add changes before releasing."
fi
ok "CHANGELOG.md has unreleased entries"

step "Running tests"
bin/rake
ok "All tests pass"

step "Running linter"
bin/standardrb
ok "StandardRB clean"

if [ "$DRY_RUN" = true ]; then
  step "Dry run complete"
  echo ""
  echo "  Current version: ${CURRENT_VERSION}"
  echo "  New version:     ${NEW_VERSION}"
  echo "  Tag:             ${TAG}"
  echo ""
  echo "  Unreleased changelog entries:"
  echo "$UNRELEASED_CONTENT" | sed 's/^/    /'
  echo ""
  echo "  All checks passed. Run without --dry-run to commit and tag."
  exit 0
fi

step "Bumping version to ${NEW_VERSION}"
sed -i '' "s/VERSION = \".*\"/VERSION = \"${NEW_VERSION}\"/" lib/kiso/icons/version.rb
ok "Updated lib/kiso/icons/version.rb"

step "Updating CHANGELOG.md"

# Replace [Unreleased] section with new version heading, add fresh [Unreleased]
REPO_URL="https://github.com/steveclarke/kiso-icons"

# Build the new compare/release links
NEW_LINKS="[Unreleased]: ${REPO_URL}/compare/${TAG}...HEAD"
VERSION_LINK="[${NEW_VERSION}]: ${REPO_URL}/releases/tag/${TAG}"

# Insert new version heading after [Unreleased], keep [Unreleased] empty
sed -i '' "s/^## \[Unreleased\]$/## [Unreleased]\n\n## [${NEW_VERSION}] - ${TODAY}/" CHANGELOG.md

# Replace the link reference lines at the bottom
sed -i '' "s|^\[Unreleased\]:.*|${NEW_LINKS}\n${VERSION_LINK}|" CHANGELOG.md

ok "Updated CHANGELOG.md"

step "Verifying gem builds"
gem build kiso-icons.gemspec --silent
rm -f kiso-icons-*.gem
ok "Gem builds successfully"

step "Committing release"
git add lib/kiso/icons/version.rb CHANGELOG.md
git commit -m "Release v${NEW_VERSION}"

step "Tagging ${TAG}"
git tag -a "$TAG" -m "Release ${NEW_VERSION}"

step "Pushing to origin"
git push origin master "$TAG"
ok "Pushed commit and tag"

step "Creating GitHub Release"

# Extract this version's changelog entries for the release body
RELEASE_NOTES=$(sed -n "/^## \[${NEW_VERSION}\]/,/^## \[/{/^## \[/!p;}" CHANGELOG.md | sed -e '/^$/d' -e '1{/^$/d;}' -e '${/^$/d;}')

if [[ "$NEW_VERSION" == *pre* || "$NEW_VERSION" == *alpha* || "$NEW_VERSION" == *beta* || "$NEW_VERSION" == *rc* ]]; then
  gh release create "$TAG" --title "$TAG" --notes "$RELEASE_NOTES" --prerelease
else
  gh release create "$TAG" --title "$TAG" --notes "$RELEASE_NOTES"
fi
ok "GitHub Release created"

step "Release complete"
echo ""
echo "  Version: ${NEW_VERSION}"
echo "  Tag:     ${TAG}"
echo "  Commit:  $(git rev-parse --short HEAD)"
echo ""
echo "  GitHub Actions will push the gem to RubyGems."
echo "  Release: ${REPO_URL}/releases/tag/${TAG}"
